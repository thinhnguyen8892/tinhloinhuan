<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tính lợi nhuận TikTok Shop 2026 – Professional</title>

<!-- OFFLINE: đặt file xlsx.bundle.js (xlsx-js-style) cùng thư mục với file HTML này -->
<script src="./xlsx.bundle.js"></script>

<style>
:root{
  --mobileBarSpace: 140px;
  --bg:#0b0f19;
  --card:#0f172a;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --line:rgba(255,255,255,.10);
  --line2:rgba(255,255,255,.16);
  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;
  --brand:#6366f1;
  --brand2:#4f46e5;
  --shadow:0 10px 24px rgba(0,0,0,.30);
  --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --sans:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --sticky-bg: rgba(17,31,61,0.98);
  --sticky-bg-hd: rgba(15,26,51,0.98);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--sans);
  color:var(--text);
  background:var(--bg);
}

.wrap{max-width:1240px;margin:auto;padding:14px 14px 18px}

.topbar{
  position:sticky;top:0;z-index:50;
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
  padding:10px 12px;
  border:1px solid var(--line);
  background:rgba(11,15,25,.98);
  border-radius:0 0 18px 18px;
}

.brand{display:flex;align-items:center;gap:10px;min-width:260px}
.logo{width:38px;height:38px;border-radius:12px;background:var(--brand)}
h1{margin:0;font-size:18px;letter-spacing:.2px}
.sub{
  margin-top:4px;color:var(--muted);font-size:12.5px;line-height:1.35;
  max-width:980px;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
}
.subMore{display:inline-block;margin-left:8px}
.subMore > summary{
  display:inline-flex;align-items:center;gap:6px;cursor:pointer;user-select:none;
  font-weight:800;color:var(--muted);
}
.subMore > summary::-webkit-details-marker{display:none}
.subMoreBody{margin-top:6px;color:var(--muted);max-width:900px}

.actions{width:100%}
.actionsRow{
  display:flex;gap:10px;align-items:center;
  flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;
  padding:6px 2px 0;
}
.actionsRow::-webkit-scrollbar{height:8px}
.actionsRow::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:999px}

button{
  border:1px solid var(--line2);
  background:rgba(255,255,255,.03);
  color:var(--text);
  padding:0 12px;border-radius:10px;
  cursor:pointer;font-weight:850;font-size:13px;
  height:40px;
}
button:hover{border-color:rgba(255,255,255,.28)}
button:focus-visible{outline:2px solid rgba(99,102,241,.55);outline-offset:2px}
.primary{background:var(--brand2);border-color:transparent}
.ghost{background:transparent}
.danger{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.25);color:#fecaca}

.moreBtn{min-width:44px;padding-inline:14px;font-size:20px;line-height:1}
.moreMenu{
  position:fixed;left:0;top:0;
  width:min(360px, calc(100vw - 24px));
  background:rgba(12,16,26,.98);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:10px;
  box-shadow:0 14px 40px rgba(0,0,0,.45);
  z-index:9999;
}
.menuGroup{padding:6px;border-radius:12px}
.menuGroup + .menuGroup{margin-top:8px;border-top:1px solid rgba(255,255,255,.08);padding-top:10px}
.menuItem{
  width:100%;justify-content:flex-start;text-align:left;
  padding:10px 12px;border-radius:12px;margin-top:6px;height:auto;
}
.menuItem:first-child{margin-top:0}

.dd{position:relative;width:100%}
.dd-btn{
  width:100%;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  border:1px solid var(--line2);
  background:rgba(255,255,255,.03);
  color:var(--text);
  padding:10px 12px;border-radius:12px;
  cursor:pointer;font-weight:850;font-size:13px;
  height:40px;
}
.dd-label{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.actionsRow.compactBar .dd{flex:0 0 auto;}
.actionsRow.compactBar .dd-btn{width:auto;min-width:150px;max-width:240px;}
.actionsRow.compactBar .dd-label{max-width:170px;}

.dd-caret{opacity:.8;font-size:12px}
.dd-menu{
  position:absolute;top:calc(100% + 8px);left:0;
  min-width:260px;max-width:340px;z-index:60;
  border:1px solid var(--line2);
  background:var(--sticky-bg);
  border-radius:14px;
  box-shadow:0 18px 60px rgba(0,0,0,.35);
  overflow:hidden;display:none;
}
.dd.open .dd-menu{display:block}
.dd-item{
  padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;
  cursor:pointer;font-weight:850;font-size:13px;color:var(--text);
  border-top:1px solid rgba(255,255,255,.06);
}
.dd-item:first-child{border-top:0}
.dd-item:hover{background:rgba(99,102,241,.12)}
.dd-item.active{background:rgba(99,102,241,.20)}
.check{opacity:0}
.dd-item.active .check{opacity:1}

.grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card-hd{
  padding:14px 14px;border-bottom:1px solid var(--line);
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.title{font-weight:950;font-size:13.5px;letter-spacing:.25px}
.mini{font-size:12px;color:var(--muted);line-height:1.35}
.section{padding:12px 14px}
.hr{height:1px;background:var(--line);margin:10px 0}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:5px;font-weight:850}
.field{
  display:flex;align-items:center;gap:10px;
  padding:10px 10px;border-radius:12px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  margin-bottom:10px;
}
.field .suffix{font-size:12px;color:var(--muted);font-family:var(--mono);white-space:nowrap}
input[type="number"], input[type="text"], input.cell-input{
  width:100%;border:1px solid rgba(255,255,255,.14);background:#0b1222;color:var(--text);
  border-radius:10px;height:36px;padding:8px 10px;outline:none;
  font-variant-numeric:tabular-nums;
}
input:focus{border-color:rgba(99,102,241,.85);box-shadow:0 0 0 3px rgba(99,102,241,.22)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:420px){.row2{grid-template-columns:1fr}}

.switch{
  display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  padding:10px 12px;border-radius:14px;margin-bottom:10px;
}
.switch .txt{display:flex;flex-direction:column;gap:2px}
.switch .txt b{font-size:13px}
.switch .txt span{font-size:12px;color:var(--muted);font-weight:650}
.toggle{width:46px;height:28px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid var(--line2);position:relative;cursor:pointer;flex:0 0 auto}
.knob{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:rgba(255,255,255,.90);box-shadow:0 8px 16px rgba(0,0,0,.22);transition:.18s ease}
.toggle.on{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.38)}
.toggle.on .knob{left:21px}

.hint{font-size:12px;color:var(--muted);font-weight:650;line-height:1.45}
.badge{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid var(--line2);background:transparent}
.badge .dot{width:9px;height:9px;border-radius:999px;background:#94a3b8}
.badge.ok{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.12);color:var(--ok)}
.badge.ok .dot{background:var(--ok)}
.badge.bad{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.12);color:var(--bad)}
.badge.bad .dot{background:var(--bad)}
.badge.na{opacity:.9}

.tablewrap{overflow:auto;border-top:1px solid var(--line)}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:2080px;table-layout:fixed;font-variant-numeric:tabular-nums}
thead th{
  position:sticky;top:0;z-index:30;
  background:#0b1222;border-bottom:1px solid var(--line2);
  padding:10px 10px;font-size:12px;color:rgba(229,231,235,.92);
  text-align:left;white-space:nowrap;font-weight:650;
  overflow:visible;
}
tbody td{border-bottom:1px solid var(--line);padding:10px 10px;vertical-align:middle;white-space:nowrap;overflow:hidden}
tbody tr:nth-child(odd){background:rgba(255,255,255,.015)}
tbody tr:hover{background:rgba(99,102,241,.08)}
.right{text-align:right}
.num{font-family:var(--mono)}

.pillWarn{
  display:inline-flex;align-items:center;gap:6px;
  border:1px solid rgba(245,158,11,.35);
  background:rgba(245,158,11,.12);
  color:var(--warn);
  padding:6px 10px;border-radius:999px;
  font-size:12px;font-weight:900;
  white-space:nowrap;
}
.actionCell{display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-wrap:wrap}
.actionCell .suggest{font-family:var(--mono);font-weight:950;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.actionCell .suggest.warn{color:var(--warn)}
.smallBtn{padding:8px 10px;border-radius:12px;font-weight:900;height:auto}
.net.positive{color:var(--ok);font-weight:950}
.net.negative{color:var(--bad);font-weight:950}

th.sticky-action, td.sticky-action{position:sticky;right:0;background:var(--sticky-bg) !important;box-shadow:-14px 0 24px rgba(0,0,0,.18)}
thead th.sticky-action{background:var(--sticky-bg-hd) !important}
th.col-action, td.col-action{min-width:320px}
th.col-del, td.col-del{min-width:92px}
th.sticky-left, td.sticky-left{position:sticky;left:0;z-index:18;background:rgba(18,24,35,.92);box-shadow:8px 0 18px rgba(0,0,0,.16)}
thead th.sticky-left{z-index:40}
.sticky-off th.sticky-action, .sticky-off td.sticky-action{position:static !important;right:auto !important;box-shadow:none !important}

.th-tip{position:relative;cursor:help;outline:none}
.th-tip::after{
  content: attr(data-tip);
  position:absolute;left:50%;bottom:100%;transform:translateX(-50%);
  min-width:220px;max-width:320px;
  background:rgba(15,26,51,.98);color:#e5e7eb;
  padding:10px 12px;border-radius:10px;font-size:12.5px;font-weight:600;line-height:1.45;
  box-shadow:0 16px 40px rgba(0,0,0,.45);
  opacity:0;pointer-events:none;margin-bottom:10px;z-index:80;
}
.th-tip::before{
  content:"";position:absolute;left:50%;bottom:100%;transform:translateX(-50%);
  border:6px solid transparent;border-top-color:rgba(15,26,51,.98);
  opacity:0;margin-bottom:-2px;
}
.th-tip:hover::after,.th-tip:hover::before,.th-tip:focus::after,.th-tip:focus::before{opacity:1}

.settingsDrawer{
  position:fixed;top:12px;left:12px;
  width:min(420px, calc(100vw - 24px));
  height:calc(100vh - 24px);
  z-index:80;
  transform:translateX(calc(-100% - 20px));
  transition:.18s ease;
  display:flex;flex-direction:column;
}
.settingsDrawer.open{transform:translateX(0)}
.settingsDrawer .section{overflow:auto;padding-bottom:18px}
.drawerClose{border:1px solid var(--line2);background:rgba(255,255,255,.03);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:900;font-size:13px;height:auto}

.backdrop{position:fixed;inset:0;background:rgba(2,6,23,.55);z-index:70;display:none}
.backdrop.show{display:block}

.mobileCards{display:none;margin-top:14px}
.mcard{
  border:1px solid var(--line2);
  background:rgba(255,255,255,.03);
  border-radius:20px;
  padding:12px;
  box-shadow:var(--shadow);
  margin-bottom:10px;
}
.mcard-hd{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
.mtitle{font-weight:800;line-height:1.2}
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:380px){.mgrid{grid-template-columns:1fr}}
.mkpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 8px}
.mchip{border:1px solid var(--line);background:rgba(255,255,255,.02);border-radius:14px;padding:10px;min-height:56px}
.mchip .k{font-size:12px;color:var(--muted);font-weight:850}
.mchip .v{margin-top:6px;font-family:var(--mono);font-weight:950;font-size:15px;text-align:right}
.mout{font-family:var(--mono);font-weight:900;text-align:right;padding:10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.02)}
.mout.positive{color:var(--ok)}
.mout.negative{color:var(--bad)}
.mtoggle{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 8px}
.mdetails{display:none}
.mcard.open .mdetails{display:block}

.mobileBar{
  display:none;
  position:fixed;left:12px;right:12px;
  bottom:calc(12px + env(safe-area-inset-bottom, 0px));
  z-index:60;
  padding:10px;border-radius:20px;
  border:1px solid var(--line2);
  background:rgba(11,15,25,.98);
  box-shadow:0 16px 50px rgba(0,0,0,.28);
}
.mobileBar .barRow{display:flex;gap:10px;justify-content:space-between;align-items:center}
.mobileBar .barBtn{
  flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
  padding:10px;border-radius:14px;border:1px solid var(--line2);
  background:rgba(255,255,255,.03);
  color:var(--text);font-weight:900;cursor:pointer;user-select:none;min-height:42px;
}
.mobileBar .barBtn.primary{background:var(--brand2);border-color:transparent}

.footer{margin-top:10px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
.disclaimer{
  margin:24px auto 12px;max-width:1200px;padding:12px 16px;border-radius:12px;
  border:1px dashed rgba(148,163,184,.25);background:rgba(255,255,255,.02);
  color:var(--muted);font-size:12.5px;font-weight:700;
}

body.quick-view .tablewrap [data-col="taxAmt"],
body.quick-view .tablewrap [data-col="diffMoney"],
body.quick-view .tablewrap [data-col="breakEvenNoHD"],
body.quick-view .tablewrap [data-col="breakEvenFullHD"],
body.quick-view .tablewrap [data-col="fixed"]{display:none !important;}
body.quick-view .tablewrap col[data-col="taxAmt"],
body.quick-view .tablewrap col[data-col="diffMoney"],
body.quick-view .tablewrap col[data-col="breakEvenNoHD"],
body.quick-view .tablewrap col[data-col="breakEvenFullHD"],
body.quick-view .tablewrap col[data-col="fixed"]{display:none !important;}

@media (max-width:720px){
  .wrap{padding:10px 10px 14px}
  .sub{-webkit-line-clamp:1}
  .tablewrap{display:none}
  .mobileCards{display:block}
  .mobileCards{padding-bottom:calc(var(--mobileBarSpace, 140px) + env(safe-area-inset-bottom, 0px))}
  .mobileBar{display:block}
}
@media (prefers-reduced-motion: reduce){
  *{transition:none !important;animation:none !important;scroll-behavior:auto !important}
}

/* ===== FIX: Export dropdown too wide (compact, pro) ===== */
#exportFilterDD.dd-compact{ flex:0 0 auto !important; width:auto !important; }
#exportFilterDD.dd-compact .dd-btn{
  width:auto !important;
  min-width: 150px !important;
  max-width: 190px !important;
  justify-content: space-between;
}
#exportFilterDD.dd-compact .dd-label{
  display:block;
  max-width: 120px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
@media (max-width: 520px){
  #exportFilterDD.dd-compact .dd-btn{
    min-width: 120px !important;
    max-width: 150px !important;
  }
  #exportFilterDD.dd-compact .dd-label{ max-width: 86px; }
}

</style>
</head>

<body class="quick-view sticky-off">
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Tính lợi nhuận TikTok Shop 2026 <span class="badge na" style="margin-left:8px;"><span class="dot"></span>Professional</span></h1>
        <div class="sub">
          <b>Công cụ định giá bán:</b> nhập giá vốn, giá bán và chi phí để ra tiền về, lợi nhuận &amp; giá bán đề xuất.
          <details class="subMore">
            <summary>Xem ghi chú</summary>
            <div class="subMoreBody">
              Nội dung chỉ mang tính chất tham khảo (Giá phụ thuộc vào phí sàn/ phí KOL....)
            </div>
          </details>
        </div>
      </div>
    </div>

    <div class="actions" aria-label="Thao tác nhanh">
      <div class="actionsRow">
        <button class="primary" id="addRowBtn">+ Thêm dòng</button>
        <button id="importBtn" class="ghost" title="Import Excel">Import</button>
        <div id="exportFilterDD" class="dd dd-compact" data-dd="export"></div>
        <button id="exportBtn" class="ghost" title="Xuất Excel">Xuất</button>

        <button id="moreBtn" class="ghost moreBtn" aria-haspopup="menu" aria-expanded="false" title="Tuỳ chọn">⋯</button>

        <div id="moreMenu" class="moreMenu" role="menu" aria-label="Tuỳ chọn" hidden>
          <div class="menuGroup">
            <button id="downloadTemplateBtn" class="ghost menuItem" role="menuitem" title="Tải file Excel mẫu">Tải mẫu</button>
            <button id="bulkApplyBtn" class="ghost menuItem" role="menuitem" title="Áp dụng giá bán đề xuất cho các dòng chưa đạt">Áp dụng đề xuất</button>
          </div>

          <div class="menuGroup">
            <div id="quickFilterDD" class="dd menuDD" data-dd="filter"></div>
            <div id="sortByDD" class="dd menuDD" data-dd="sort"></div>
            <button class="ghost menuItem" id="quickViewBtn" role="menuitem" title="Chế độ nhập nhanh (gọn) / xem đầy đủ cột">Chế độ: Nhập nhanh</button>
            <button class="ghost menuItem" id="stickyToggleBtn" role="menuitem" title="Bật/tắt cố định cột Giá bán lẻ đề xuất">Sticky: OFF</button>
            <button class="ghost menuItem" id="toggleAdvancedBtn" role="menuitem" title="Ẩn/hiện cột nâng cao">Cột nâng cao: ON</button>
          </div>

          <div class="menuGroup">
            <button class="ghost menuItem" id="settingsBtn" role="menuitem" title="Mở cài đặt">Cài đặt</button>
            <button class="ghost menuItem" id="helpBtn" role="menuitem" title="Hướng dẫn sử dụng">Hướng dẫn</button>
            <button class="danger menuItem" id="resetBtn" role="menuitem" title="Xoá dữ liệu trên trang">Reset</button>
          </div>
        </div>

        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none"/>
      </div>
    </div>
  </div>

  <!-- Help Drawer -->
  <div class="card settingsDrawer" id="helpPanel" aria-label="Hướng dẫn">
    <div class="card-hd">
      <div>
        <div class="title">Hướng dẫn sử dụng</div>
        <div class="sub" style="-webkit-line-clamp:unset;max-width:420px">Dành cho người mới – làm theo 4 bước để ra giá bán chuẩn.</div>
      </div>
      <button class="drawerClose" id="helpCloseBtn" title="Đóng hướng dẫn">Đóng</button>
    </div>
    <div class="section">
      <div class="hint" style="margin-bottom:10px">
        <b>Gợi ý:</b> Nhập <b>Giá bán</b>, <b>Giá vốn (HĐ)</b>, <b>Giá vốn thực tế</b> → hệ thống tự ra <b>Tiền về</b>, <b>Lợi nhuận</b>, <b>Lãi ròng</b> và <b>Giá đề xuất</b>.
      </div>
      <div class="hr"></div>
      <div class="hint">
        <b>Ý nghĩa nhanh:</b><br/>
        • <b>Tiền về</b>: tiền thực nhận sau phí (theo % tiền về/AFF).<br/>
        • <b>Lợi nhuận thực tế</b>: tiền về − vốn thực tế − thuế (kế toán).<br/>
        • <b>% chuẩn</b>: lợi nhuận thực tế / giá bán.<br/>
        • <b>Lãi ròng</b>: lợi nhuận thực tế − phí cố định (nếu bật).<br/>
      </div>
    </div>
  </div>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <div class="grid">
    <!-- Settings Drawer -->
    <div class="card settingsDrawer" id="settingsPanel" aria-label="Cài đặt">
      <div class="card-hd">
        <div>
          <div class="title">Cài đặt chung</div>
          <div class="mini">Tập trung đúng “chuẩn kế toán”: tách <span style="font-family:var(--mono)">Lợi nhuận tính thuế</span> và <span style="font-family:var(--mono)">Lãi ròng</span>.</div>
        </div>
        <button class="drawerClose" id="settingsCloseBtn" title="Đóng cài đặt">Đóng</button>
      </div>

      <div class="section">
        <h3 style="margin:0 0 10px 0;color:var(--muted);font-size:12px;letter-spacing:.35px;text-transform:uppercase;">Mục tiêu &amp; làm tròn</h3>

        <div class="field">
          <div style="width:100%">
            <label>% mục tiêu (Lợi nhuận thực tế / Giá bán)</label>
            <input id="targetPct" type="number" value="7" step="0.01" min="0" max="99">
          </div>
          <div class="suffix">%</div>
        </div>

        <div class="field">
          <div style="width:100%">
            <label>Làm tròn giá đề xuất</label>
            <input id="roundStep" type="number" value="1000" step="100" min="1">
          </div>
          <div class="suffix">VNĐ</div>
        </div>

        <div class="hr"></div>

        <h3 style="margin:0 0 10px 0;color:var(--muted);font-size:12px;letter-spacing:.35px;text-transform:uppercase;">Tiền về &amp; thuế</h3>

        <div class="field">
          <div style="width:100%">
            <label>Phí % tiền về (phí sàn/affiliate/khác)</label>
            <input id="moneyBackFeePct" type="number" value="27" step="0.01" min="0" max="99">
          </div>
          <div class="suffix">%</div>
        </div>

        <div class="row2">
          <div class="field" style="margin-bottom:0">
            <div style="width:100%">
              <label>Thuế (kế toán) suất (%)</label>
              <input id="taxPct" type="number" value="17" step="0.01" min="0" max="100">
            </div>
            <div class="suffix">%</div>
          </div>

          <div class="field" style="margin-bottom:0">
            <div style="width:100%">
              <label>Chi phí sàn tính thuế (%)</label>
              <input id="feeTaxPct" type="number" value="22" step="0.01" min="0" max="100">
            </div>
            <div class="suffix">%</div>
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          <b>Lợi nhuận tính thuế</b> = <span style="font-family:var(--mono)">Giá bán − Giá vốn (HĐ) − (Chi phí sàn tính thuế × Giá bán)</span><br/>
          <b>Thuế (kế toán)</b> = <span style="font-family:var(--mono)">Thuế suất × MAX(0, Lợi nhuận tính thuế)</span><br/>
          <b>Lợi nhuận thực tế</b> = <span style="font-family:var(--mono)">Tiền về − Giá vốn thực tế − Thuế</span>
        </div>

        <div class="hr"></div>

        <h3 style="margin:0 0 10px 0;color:var(--muted);font-size:12px;letter-spacing:.35px;text-transform:uppercase;">Chi phí cố định (ảnh hưởng lãi ròng)</h3>

        <div class="switch">
          <div class="txt">
            <b>Áp phí xử lý đơn (trừ vào lãi ròng)</b>
            <span>Không ảnh hưởng “% chuẩn”, chỉ ảnh hưởng lãi ròng.</span>
          </div>
          <div class="toggle on" id="processToggle" role="switch" aria-checked="true" tabindex="0"><div class="knob"></div></div>
        </div>

        <div class="field">
          <div style="width:100%">
            <label>Phí xử lý / đơn</label>
            <input id="processFee" type="number" value="3000" step="1" min="0">
          </div>
          <div class="suffix">VNĐ</div>
        </div>

        <div class="switch">
          <div class="txt">
            <b>Áp phí hoàn (SFR / hoàn vận chuyển) (trừ vào lãi ròng)</b>
            <span>Bật nếu muốn trừ thêm phí hoàn. Tắt = 0.</span>
          </div>
          <div class="toggle" id="refundToggle" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
        </div>

        <div class="field" style="margin-bottom:0">
          <div style="width:100%">
            <label>Phí hoàn / đơn (khi bật)</label>
            <input id="refundFee" type="number" value="3000" step="1" min="0">
          </div>
          <div class="suffix">VNĐ</div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-hd">
        <div>
          <div class="title">Bảng tính</div>
          <div class="mini">Tip: nhập nhanh <span style="font-family:var(--mono)">380 → 380.000</span>. Rời ô sẽ tự format.</div>
        </div>
        <div class="mini">“% chuẩn” = <span style="font-family:var(--mono)">Lợi nhuận thực tế / Giá bán</span> • Trạng thái dựa trên <span style="font-family:var(--mono)">Lãi ròng</span>.</div>
      </div>

      <div class="tablewrap">
        <table>
          <colgroup>
            <col style="width:260px" data-col="name">
            <col style="width:140px" data-col="sale">
            <col style="width:140px" data-col="affFeePct">
            <col style="width:140px" data-col="costInvoice">
            <col style="width:140px" data-col="costReal">
            <col style="width:140px" data-col="moneyBack">
            <col style="width:140px" data-col="taxAmt">
            <col style="width:140px" data-col="diffMoney">
            <col style="width:140px" data-col="realProfit">
            <col style="width:110px" data-col="breakEvenNoHD">
            <col style="width:110px" data-col="breakEvenFullHD">
            <col style="width:120px" data-col="roiMb">
            <col style="width:140px" data-col="hitTarget">
            <col style="width:140px" data-col="fixed">
            <col style="width:180px" data-col="net">
            <col style="width:190px" data-col="status">
            <col style="width:320px" data-col="action">
            <col style="width:92px" data-col="del">
          </colgroup>
          <thead>
            <tr>
              <th class="sticky-left" data-col="name"><span class="th-tip" tabindex="0" data-tip="Tên sản phẩm/SKU để bạn quản lý.">Sản phẩm</span></th>
              <th class="right" data-col="sale"><span class="th-tip" tabindex="0" data-tip="Giá bạn dự định bán ra (P).">Giá bán</span></th>
              <th class="right" data-col="affFeePct"><span class="th-tip" tabindex="0" data-tip="Phí Affiliate/KOL ảnh hưởng trực tiếp đến Tiền về. Nếu trống dùng mặc định 27%.">Phí AFF (%)</span></th>
              <th class="right" data-col="costInvoice"><span class="th-tip" tabindex="0" data-tip="Giá vốn theo hóa đơn (C_invoice) – dùng cho kế toán/thuế.">Giá vốn (hóa đơn)</span></th>
              <th class="right" data-col="costReal"><span class="th-tip" tabindex="0" data-tip="Giá vốn thực tế (C_real) – dùng để ra lãi thực tế.">Giá vốn thực tế</span></th>
              <th class="right" data-col="moneyBack"><span class="th-tip" tabindex="0" data-tip="Số tiền bạn dự kiến thực nhận sau khi trừ phí.">Tiền về</span></th>
              <th class="right" data-col="taxAmt"><span class="th-tip" tabindex="0" data-tip="Thuế kế toán (chỉ tính khi có lãi tính thuế).">Thuế</span></th>
              <th class="right" data-col="diffMoney"><span class="th-tip" tabindex="0" data-tip="Tiền về − Giá vốn thực tế.">Tiền chênh</span></th>
              <th class="right" data-col="realProfit"><span class="th-tip" tabindex="0" data-tip="Tiền chênh − Thuế.">LN thực tế</span></th>
              <th class="right" data-col="breakEvenNoHD"><span class="th-tip" tabindex="0" data-tip="Giá bán hòa vốn khi HĐ thấp hơn thực tế.">HV thiếu HĐ</span></th>
              <th class="right" data-col="breakEvenFullHD"><span class="th-tip" tabindex="0" data-tip="Giá bán hòa vốn khi đủ hóa đơn.">HV đủ HĐ</span></th>
              <th class="right" data-col="roiMb"><span class="th-tip" tabindex="0" data-tip="Lợi nhuận thực tế / Giá bán.">% chuẩn</span></th>
              <th data-col="hitTarget"><span class="th-tip" tabindex="0" data-tip="Đạt/Chưa đạt % mục tiêu.">Đạt?</span></th>
              <th class="right adv" data-col="fixed"><span class="th-tip" tabindex="0" data-tip="Phí cố định (xử lý/hoàn).">Phí cố định</span></th>
              <th class="right" data-col="net"><span class="th-tip" tabindex="0" data-tip="Lãi ròng = LN thực tế − phí cố định.">Lãi ròng</span></th>
              <th data-col="status"><span class="th-tip" tabindex="0" data-tip="Tổng quan nhanh: LÃI hoặc LỖ theo lãi ròng.">Trạng thái</span></th>
              <th class="right sticky-action col-action" data-col="action"><span class="th-tip" tabindex="0" data-tip="Giá bán lẻ đề xuất theo % mục tiêu và áp dụng nhanh.">Giá bán lẻ đề xuất</span></th>
              <th class="right col-del" data-col="del"></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Mobile cards -->
  <div id="mobileCards" class="mobileCards" aria-label="Bảng nhập liệu dạng thẻ (mobile)"></div>

  <!-- Mobile bottom bar -->
  <div class="mobileBar" id="mobileBar" aria-label="Thanh thao tác nhanh">
    <div class="barRow">
      <div class="barBtn primary" id="mbAdd">+ Thêm</div>
      <div class="barBtn" id="mbImport">Import</div>
      <div class="barBtn" id="mbApply">Áp dụng</div>
      <div class="barBtn" id="mbMore">⋯</div>
    </div>
  </div>

  <div class="footer">
    <div>Phiên bản online • Không lưu dữ liệu (mỗi lần mở trang là phiên mới).</div>
    <div>Made by <b>Thịnh Nguyễn</b></div>
  </div>
</div>

<div class="disclaimer">
  <b>Lưu ý:</b> Công cụ này dùng để <b>hỗ trợ ra quyết định giá bán</b> dựa trên các thông tin người dùng cung cấp.
  Kết quả hiển thị mang tính tham khảo, <b>không phải tư vấn tài chính hay kế toán</b>.
</div>

<script>
/* ================= Helpers ================= */
const $ = (id) => document.getElementById(id);

const fmt = (n) => {
  if (!isFinite(n)) return "";
  let s = String(n);
  const neg = s.startsWith("-");
  if (neg) s = s.slice(1);
  const parts = s.split(".");
  const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  const fracPart = parts[1] ? parts[1].replace(/0+$/,"") : "";
  const out = fracPart ? (intPart + "." + fracPart) : intPart;
  return (neg ? "-" : "") + out;
};

const parseMoney = (v) => {
  if (v === "" || v === null || v === undefined) return NaN;
  const raw = String(v).trim();
  if (!raw) return NaN;
  const hasK = /k\s*$/i.test(raw);
  const hasSep = raw.includes(".") || raw.includes(",") || raw.includes(" ");
  const digits = raw.replace(/[^\d]/g, "");
  if (!digits) return NaN;
  let n = Number(digits);
  if (!isFinite(n)) return NaN;
  if (hasK || (!hasSep && n > 0 && n < 10000)) n = n * 1000; // nhập 380 => 380.000
  return n;
};

const escapeHtml = (s) => (s ?? "").toString()
  .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
  .replace(/"/g,"&quot;").replace(/'/g,"&#039;");

const fmtPct = (x) => isFinite(x) ? (Math.round(x * 10000) / 100).toFixed(2) + "%" : "";
const roundUp = (n, step=1000) => Math.ceil(n/step) * step;
function safePct(p){ const x = Number(p); return isFinite(x) ? Math.min(Math.max(x, 0), 99.99) : 0; }

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

function toast(msg){
  // tối giản: alert trên web, không dùng localStorage
  alert(msg);
}

/* ================= State (no persistence) ================= */
const DEFAULT_STATE = {
  settings: {
    targetPct: 7,
    roundStep: 1000,
    moneyBackFeePct: 27,
    taxPct: 17,
    feeTaxPct: 22,
    processOn: true,
    processFee: 3000,
    refundOn: false,
    refundFee: 3000,
    advancedColsOn: true,
    stickyOn: false,
    quickFilter: "all",
    sortBy: "none",
    exportMode: "all",
    quickViewOn: true
  },
  rows: [
    { name: "SP 1", sale: "", affFeePct: "", costInvoice: "", costReal: "" }
  ]
};
let state = JSON.parse(JSON.stringify(DEFAULT_STATE));

/* ================= Core logic ================= */
function calcRow(r){
  const P = parseMoney(r.sale);
  const C_invoice = parseMoney(r.costInvoice ?? r.cost);
  const C_real = parseMoney(r.costReal ?? r.costInvoice ?? r.cost);

  const feeMB = safePct((r.affFeePct!==undefined && String(r.affFeePct).trim()!=="" ? r.affFeePct : state.settings.moneyBackFeePct))/100;
  const feeTax = safePct(state.settings.feeTaxPct)/100;
  const taxRate = safePct(state.settings.taxPct)/100;

  const moneyBackRaw = isFinite(P) ? (P * (1 - feeMB)) : NaN;
  const moneyBack = isFinite(moneyBackRaw) ? Math.round(moneyBackRaw) : NaN;

  const taxBase = (isFinite(P) && isFinite(C_invoice))
    ? (P - C_invoice - (P * feeTax))
    : NaN;

  const taxAmtRaw = (isFinite(taxBase) && taxBase > 0) ? (taxBase * taxRate) : 0;
  const taxAmt = Math.round(taxAmtRaw);

  const diffMoneyRaw = (isFinite(moneyBack) && isFinite(C_real)) ? (moneyBack - C_real) : NaN;
  const diffMoney = isFinite(diffMoneyRaw) ? Math.round(diffMoneyRaw) : NaN;

  const realProfitRaw = isFinite(diffMoney) ? (diffMoney - taxAmt) : NaN;
  const realProfit = isFinite(realProfitRaw) ? Math.round(realProfitRaw) : NaN;

  const roiOnSale = (isFinite(realProfit) && isFinite(P) && P > 0) ? (realProfit / P) : NaN;

  const fixed =
    (state.settings.processOn ? Number(state.settings.processFee || 0) : 0) +
    (state.settings.refundOn ? Number(state.settings.refundFee || 0) : 0);

  const netRaw = isFinite(realProfit) ? (realProfit - fixed) : NaN;
  const net = isFinite(netRaw) ? Math.round(netRaw) : NaN;
  const status = isFinite(net) ? (net >= 0 ? "LÃI" : "LỖ") : "";

  return { moneyBack, taxAmt, diffMoney, realProfit, roiOnSale, fixed, net, status };
}

function suggestSaleMinForTarget(costInvoiceValue, costRealValue){
  const Cinv = Number(costInvoiceValue);
  const Creal = Number(costRealValue);
  if(!isFinite(Creal) || Creal <= 0) return { ok:false, reason:"Giá vốn thực tế không hợp lệ" };
  if(!isFinite(Cinv) || Cinv <= 0) return { ok:false, reason:"Giá vốn hóa đơn không hợp lệ" };

  const r = safePct(state.settings.targetPct)/100;
  const step = Math.max(1, Number(state.settings.roundStep || 1000));
  const feeMB = safePct(state.settings.moneyBackFeePct)/100;
  const feeTax = safePct(state.settings.feeTaxPct)/100;
  const t = safePct(state.settings.taxPct)/100;

  const m = 1 - feeMB;

  function realProfitAt(P){
    if(!isFinite(P) || P <= 0) return -Infinity;
    const moneyBack = Math.round(P * m);
    const taxBase = P - Cinv - (P * feeTax);
    const taxAmt = (isFinite(taxBase) && taxBase > 0) ? Math.round(taxBase * t) : 0;
    return moneyBack - Creal - taxAmt;
  }
  function okAt(P){
    const rp = realProfitAt(P);
    if(!isFinite(rp) || !isFinite(P) || P <= 0) return false;
    return (rp / P) >= r;
  }

  let lo = 0;
  let hi = Math.max(Creal / Math.max(m, 1e-9), Cinv / Math.max(1 - feeTax, 1e-9));
  if(!isFinite(hi) || hi <= 0) hi = 1000;
  hi = Math.max(hi, 1000) * 1.2;

  const HI_CAP = 2_000_000_000;
  while(hi < HI_CAP && !okAt(hi)) hi *= 1.5;
  if(!okAt(hi)) return { ok:false, reason:"Không tìm được giá đề xuất (phí/thuế quá cao?)" };

  for(let it=0; it<60; it++){
    const mid = (lo + hi) / 2;
    if(okAt(mid)) hi = mid; else lo = mid;
  }
  return { ok:true, sale: roundUp(hi, step) };
}

function breakEvenSaleBySolve(costInvoiceValue, costRealValue){
  const Cinv = Number(costInvoiceValue);
  const Creal = Number(costRealValue);
  if(!isFinite(Creal) || Creal <= 0) return { ok:false };
  if(!isFinite(Cinv) || Cinv <= 0) return { ok:false };

  const step = Math.max(1, Number(state.settings.roundStep || 1000));
  const feeMB  = safePct(state.settings.moneyBackFeePct)/100;
  const feeTax = safePct(state.settings.feeTaxPct)/100;
  const t      = safePct(state.settings.taxPct)/100;

  const m = 1 - feeMB;
  const k = 1 - feeTax;

  const realProfitAt = (P)=>{
    const moneyBack = m * P;
    const taxBase = k * P - Cinv;
    const taxAmt = taxBase > 0 ? (t * taxBase) : 0;
    return moneyBack - Creal - taxAmt;
  };

  let lo = 0;
  let hi = Math.max(1000, Creal / Math.max(m, 1e-9));
  const HI_CAP = 5e9;
  while(realProfitAt(hi) < 0 && hi < HI_CAP) hi *= 1.5;
  if(hi >= HI_CAP && realProfitAt(hi) < 0) return { ok:false };

  while(hi - lo > 1){
    const mid = Math.floor((lo + hi) / 2);
    if(realProfitAt(mid) >= 0) hi = mid; else lo = mid;
  }
  return { ok:true, sale: roundUp(hi, step) };
}

/* ================= DOM build/update ================= */
const tbody = $("tbody");
const mobileCards = $("mobileCards");

function buildRowDOM(i){
  const r = state.rows[i];
  const tr = document.createElement("tr");
  tr.dataset.i = String(i);
  tr.innerHTML = `
    <td class="sticky-left" data-col="name"><input class="cell-input name" data-k="name" data-i="${i}" value="${escapeHtml(r.name)}" placeholder="Tên SP"></td>
    <td class="right" data-col="sale"><input inputmode="numeric" pattern="[0-9]*" class="cell-input small right" data-k="sale" data-i="${i}" value="${escapeHtml(r.sale)}" placeholder="VD: 380"></td>
    <td class="right" data-col="affFeePct"><input inputmode="decimal" pattern="[0-9.]*" class="cell-input small right" data-k="affFeePct" data-i="${i}" value="${escapeHtml(r.affFeePct ?? "")}" placeholder="27"></td>
    <td class="right" data-col="costInvoice"><input inputmode="numeric" pattern="[0-9]*" class="cell-input small right" data-k="costInvoice" data-i="${i}" value="${escapeHtml(r.costInvoice ?? r.cost ?? "")}" placeholder="VD: 225"></td>
    <td class="right" data-col="costReal"><input inputmode="numeric" pattern="[0-9]*" class="cell-input small right" data-k="costReal" data-i="${i}" value="${escapeHtml(r.costReal ?? r.costInvoice ?? r.cost ?? "")}" placeholder="VD: 225"></td>

    <td class="right num" data-out="moneyBack" data-col="moneyBack"></td>
    <td class="right num" data-out="taxAmt" data-col="taxAmt"></td>
    <td class="right num" data-out="diffMoney" data-col="diffMoney"></td>
    <td class="right num" data-out="realProfit" data-col="realProfit"></td>

    <td class="right num" data-out="breakEvenNoHD" data-col="breakEvenNoHD"></td>
    <td class="right num" data-out="breakEvenFullHD" data-col="breakEvenFullHD"></td>
    <td class="right num" data-out="roiMb" data-col="roiMb"></td>
    <td data-out="hitTarget" data-col="hitTarget"></td>

    <td class="right num adv" data-out="fixed" data-col="fixed"></td>
    <td class="right num" data-out="net" data-col="net"></td>
    <td data-out="status" data-col="status"></td>

    <td class="right sticky-action col-action" data-out="action" data-col="action"></td>
    <td class="right col-del" data-col="del"><button class="danger smallBtn" data-action="del" data-del="${i}" title="Xóa dòng">Xóa</button></td>
  `;
  return tr;
}

function buildMobileCardDOM(i){
  const r = state.rows[i];
  const card = document.createElement("div");
  card.className = "mcard";
  card.dataset.i = String(i);
  card.innerHTML = `
    <div class="mcard-hd">
      <div style="min-width:0;flex:1">
        <div class="mtitle">#${i+1} · <span style="font-family:var(--mono)">${escapeHtml(r.name || ("SP "+(i+1)))}</span></div>
      </div>
      <button class="danger smallBtn" data-action="del" data-del="${i}" title="Xóa dòng">Xóa</button>
    </div>

    <div class="mgrid">
      <div class="mfield"><label>Sản phẩm</label>
        <input class="cell-input name" data-k="name" data-i="${i}" value="${escapeHtml(r.name)}" placeholder="Tên SP">
      </div>
      <div class="mfield"><label>Giá bán</label>
        <input inputmode="numeric" pattern="[0-9]*" class="cell-input small right" data-k="sale" data-i="${i}" value="${escapeHtml(r.sale)}" placeholder="VD: 380">
      </div>
      <div class="mfield"><label>Phí AFF (%)</label>
        <input inputmode="decimal" pattern="[0-9.]*" class="cell-input small right" data-k="affFeePct" data-i="${i}" value="${escapeHtml(r.affFeePct ?? "")}" placeholder="27">
      </div>
      <div class="mfield"><label>Giá vốn (HĐ)</label>
        <input inputmode="numeric" pattern="[0-9]*" class="cell-input small right" data-k="costInvoice" data-i="${i}" value="${escapeHtml(r.costInvoice ?? r.cost ?? "")}" placeholder="VD: 225">
      </div>
      <div class="mfield"><label>Giá vốn (thực)</label>
        <input inputmode="numeric" pattern="[0-9]*" class="cell-input small right" data-k="costReal" data-i="${i}" value="${escapeHtml(r.costReal ?? r.costInvoice ?? r.cost ?? "")}" placeholder="VD: 225">
      </div>
    </div>

    <div class="mkpis">
      <div class="mchip"><div class="k">Tiền về</div><div class="v" data-out="moneyBack"></div></div>
      <div class="mchip"><div class="k">LN thực tế</div><div class="v" data-out="realProfit"></div></div>
      <div class="mchip"><div class="k">Lãi ròng</div><div class="v" data-out="net"></div></div>
      <div class="mchip"><div class="k">% chuẩn</div><div class="v" data-out="roiMb"></div></div>
      <div class="mchip"><div class="k">Trạng thái</div><div class="v" data-out="status"></div></div>
    </div>

    <div class="mtoggle">
      <span class="hint" style="margin:0">Chi tiết (thuế, chênh, hòa vốn)</span>
      <button class="smallBtn ghost" data-action="toggleDetails" data-i="${i}">
        <span class="toggleText">Xem thêm</span> <span class="toggleIcon" style="display:inline-block;transition:.15s">▾</span>
      </button>
    </div>

    <div class="mdetails">
      <div class="mgrid">
        <div class="mfield"><label>Thuế</label><div class="mout" data-out="taxAmt"></div></div>
        <div class="mfield"><label>Tiền chênh</label><div class="mout" data-out="diffMoney"></div></div>
        <div class="mfield"><label>HV thiếu HĐ</label><div class="mout" data-out="breakEvenNoHD"></div></div>
        <div class="mfield"><label>HV đủ HĐ</label><div class="mout" data-out="breakEvenFullHD"></div></div>
      </div>
      <div class="hr"></div>
      <div class="actionCell" style="justify-content:flex-end" data-out="action"></div>
    </div>
  `;
  return card;
}

function getRowMeta(i){
  const row = state.rows[i];
  const c = calcRow(row);
  const costReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
  const costInv0 = parseMoney(row.costInvoice ?? row.cost);
  const costInv = isFinite(costInv0) ? costInv0 : costReal;
  const sug = isFinite(costReal) ? suggestSaleMinForTarget(costInv, costReal) : { ok:false };
  const sugSale = sug.ok ? sug.sale : NaN;
  const saleNow = parseMoney(row.sale);
  const warn = isFinite(sugSale) && isFinite(saleNow) && saleNow > 0 && saleNow < sugSale;
  const rTarget = safePct(state.settings.targetPct)/100;
  const hit = isFinite(c.roiOnSale) && c.roiOnSale >= rTarget;
  const loss = isFinite(c.net) && c.net < 0;
  return { c, sugSale, warn, hit, loss };
}

function getVisibleIndices(){
  const idxs = state.rows.map((_, i)=>i);
  const f = state.settings.quickFilter || "all";
  const filtered = idxs.filter(i=>{
    const meta = getRowMeta(i);
    if(f === "not_hit") return !meta.hit;
    if(f === "loss") return meta.loss;
    if(f === "warn") return meta.warn;
    return true;
  });

  const s = state.settings.sortBy || "none";
  if(s === "none") return filtered;

  const withMeta = filtered.map(i=>({i, ...getRowMeta(i)}));
  const num = (x)=> (isFinite(x) ? x : -Infinity);

  withMeta.sort((a,b)=>{
    if(s === "roi_desc") return num(b.c.roiOnSale) - num(a.c.roiOnSale);
    if(s === "roi_asc")  return num(a.c.roiOnSale) - num(b.c.roiOnSale);
    if(s === "net_desc") return num(b.c.net) - num(a.c.net);
    if(s === "net_asc")  return num(a.c.net) - num(b.c.net);
    if(s === "suggest_desc") return num(b.sugSale) - num(a.sugSale);
    if(s === "suggest_asc")  return num(a.sugSale) - num(b.sugSale);
    return 0;
  });

  return withMeta.map(x=>x.i);
}

function updateRowDOM(i){
  const tr = tbody.querySelector(`tr[data-i="${i}"]`);
  if(!tr) return;
  const row = state.rows[i];
  const c = calcRow(row);

  const set = (key, html) => {
    const el = tr.querySelector(`[data-out="${key}"]`);
    if (el) el.innerHTML = html;
  };

  set("moneyBack", fmt(c.moneyBack));
  set("taxAmt", fmt(c.taxAmt));
  set("diffMoney", fmt(c.diffMoney));
  set("realProfit", isFinite(c.realProfit) ? `<span class="net ${c.realProfit>=0?'positive':'negative'}">${fmt(c.realProfit)}</span>` : "");

  const cInv = parseMoney(row.costInvoice ?? row.cost);
  const cReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
  const beNoHD = (isFinite(cInv) && isFinite(cReal)) ? breakEvenSaleBySolve(cInv, cReal) : { ok:false };
  const beFullHD = (isFinite(cReal)) ? breakEvenSaleBySolve(cReal, cReal) : { ok:false };
  set("breakEvenNoHD", beNoHD.ok ? fmt(beNoHD.sale) : "");
  set("breakEvenFullHD", beFullHD.ok ? fmt(beFullHD.sale) : "");

  set("fixed", fmt(c.fixed));

  const rTarget = safePct(state.settings.targetPct)/100;
  const roiMb = c.roiOnSale;
  set("roiMb", isFinite(roiMb) ? `<span class="net ${roiMb>=rTarget?'positive':'negative'}">${fmtPct(roiMb)}</span>` : "");

  let hitBadge = `<span class="badge na"><span class="dot"></span>—</span>`;
  if (isFinite(roiMb)) hitBadge = (roiMb >= rTarget) ? `<span class="badge ok"><span class="dot"></span>ĐẠT</span>` : `<span class="badge bad"><span class="dot"></span>CHƯA</span>`;
  set("hitTarget", hitBadge);

  const costReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
  const costInv0 = parseMoney(row.costInvoice ?? row.cost);
  const costInv = isFinite(costInv0) ? costInv0 : costReal;
  const saleNow = parseMoney(row.sale);
  const sug = isFinite(costReal) ? suggestSaleMinForTarget(costInv, costReal) : { ok:false };

  if (sug.ok) {
    const warn = isFinite(saleNow) && saleNow > 0 && saleNow < sug.sale;
    set("action", `
      <div class="actionCell">
        <span class="suggest ${warn?'warn':''}">${fmt(sug.sale)}</span>
        ${warn ? `<span class="pillWarn">⚠ Giá bán &lt; đề xuất</span>` : ``}
        <button class="smallBtn primary" data-action="applySuggest" data-i="${i}" title="Áp dụng giá bán đề xuất">Áp dụng</button>
      </div>
    `);
  } else {
    set("action", `<span class="hint">Nhập giá vốn</span>`);
  }

  set("net", isFinite(c.net) ? `<span class="net ${c.net>=0?'positive':'negative'}">${fmt(c.net)}</span>` : "");

  let badge = `<span class="badge na"><span class="dot"></span>—</span>`;
  if (c.status === "LÃI") badge = `<span class="badge ok"><span class="dot"></span>LÃI</span>`;
  if (c.status === "LỖ")  badge = `<span class="badge bad"><span class="dot"></span>LỖ</span>`;
  set("status", badge);
}

function updateMobileCardDOM(i){
  const card = mobileCards?.querySelector(`.mcard[data-i="${i}"]`);
  if(!card) return;
  const row = state.rows[i];
  const c = calcRow(row);

  const set = (key, html) => {
    const el = card.querySelector(`[data-out="${key}"]`);
    if(el) el.innerHTML = html;
  };

  set("moneyBack", fmt(c.moneyBack));
  set("taxAmt", fmt(c.taxAmt));
  set("diffMoney", fmt(c.diffMoney));
  set("realProfit", isFinite(c.realProfit) ? `<span class="${c.realProfit>=0?'mout positive':'mout negative'}">${fmt(c.realProfit)}</span>` : "");
  set("net", isFinite(c.net) ? `<span class="${c.net>=0?'mout positive':'mout negative'}">${fmt(c.net)}</span>` : "");

  const cInv = parseMoney(row.costInvoice ?? row.cost);
  const cReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
  const beNoHD = (isFinite(cInv) && isFinite(cReal)) ? breakEvenSaleBySolve(cInv, cReal) : { ok:false };
  const beFullHD = (isFinite(cReal)) ? breakEvenSaleBySolve(cReal, cReal) : { ok:false };
  set("breakEvenNoHD", beNoHD.ok ? fmt(beNoHD.sale) : "");
  set("breakEvenFullHD", beFullHD.ok ? fmt(beFullHD.sale) : "");

  const rTarget = safePct(state.settings.targetPct)/100;
  const roi = c.roiOnSale;
  set("roiMb", isFinite(roi) ? `<span class="${roi>=rTarget?'mout positive':'mout negative'}">${fmtPct(roi)}</span>` : "");

  let badge = `<span class="badge na"><span class="dot"></span>—</span>`;
  if (c.status === "LÃI") badge = `<span class="badge ok"><span class="dot"></span>LÃI</span>`;
  if (c.status === "LỖ")  badge = `<span class="badge bad"><span class="dot"></span>LỖ</span>`;
  set("status", badge);

  const costReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
  const costInv0 = parseMoney(row.costInvoice ?? row.cost);
  const costInv = isFinite(costInv0) ? costInv0 : costReal;
  const saleNow = parseMoney(row.sale);
  const sug = isFinite(costReal) ? suggestSaleMinForTarget(costInv, costReal) : { ok:false };

  const actionEl = card.querySelector('[data-out="action"]');
  if(actionEl){
    if(sug.ok){
      const warn = isFinite(saleNow) && saleNow > 0 && saleNow < sug.sale;
      actionEl.innerHTML = `
        <span class="suggest ${warn?'warn':''}">${fmt(sug.sale)}</span>
        ${warn ? `<span class="pillWarn">⚠ Giá bán &lt; đề xuất</span>` : ``}
        <button class="smallBtn primary" data-action="applySuggest" data-i="${i}" title="Áp dụng giá bán đề xuất">Áp dụng</button>
      `;
    } else {
      actionEl.innerHTML = `<span class="hint">Nhập giá vốn</span>`;
    }
  }
}

function rebuildMobileCards(){
  if(!mobileCards) return;
  mobileCards.innerHTML = "";
  state.rows.forEach((_, i)=> mobileCards.appendChild(buildMobileCardDOM(i)));
  state.rows.forEach((_, i)=> updateMobileCardDOM(i));
}

function applyAdvancedCols(){
  const on = !!state.settings.advancedColsOn;
  document.querySelectorAll(".adv").forEach(el=> el.style.display = on ? "" : "none");
}

function rebuildTable(){
  tbody.innerHTML = "";
  const visible = getVisibleIndices();
  visible.forEach(i=> tbody.appendChild(buildRowDOM(i)));
  visible.forEach(i=> updateRowDOM(i));
  rebuildMobileCards();
  applyAdvancedCols();
  updateStickyClass();
  updateQuickViewClass();
}

/* ================= Dropdown builders ================= */
function buildDD(elId, cfg){
  const el = $(elId);
  if(!el) return;
  el.innerHTML = `
    <button class="dd-btn" type="button" aria-haspopup="menu" aria-expanded="false">
      <span>${cfg.label()}</span>
      <span class="dd-caret">▾</span>
    </button>
    <div class="dd-menu" role="menu"></div>
  `;
  const btn = el.querySelector(".dd-btn");
  const menu = el.querySelector(".dd-menu");

  function render(){
    btn.querySelector("span").textContent = cfg.label();
    menu.innerHTML = cfg.items().map(it=>`
      <div class="dd-item ${it.value===cfg.value()?'active':''}" role="menuitem" data-val="${it.value}">
        <div style="display:flex;flex-direction:column;gap:2px;min-width:0">
          <div>${it.text}</div>
          ${it.sub ? `<span class="sub">${it.sub}</span>` : ``}
        </div>
        <span class="check">✓</span>
      </div>
    `).join("");
  }
  render();

  btn.addEventListener("click", (e)=>{
    e.stopPropagation();
    const open = el.classList.toggle("open");
    btn.setAttribute("aria-expanded", open ? "true" : "false");
  });

  menu.addEventListener("click", (e)=>{
    const item = e.target.closest(".dd-item");
    if(!item) return;
    cfg.set(item.dataset.val);
    el.classList.remove("open");
    btn.setAttribute("aria-expanded", "false");
    render();
    rebuildTable();
  });

  document.addEventListener("click", ()=>{ el.classList.remove("open"); btn.setAttribute("aria-expanded","false"); });
}

/* ================= Sticky / Quick view ================= */
function updateStickyClass(){
  document.body.classList.toggle("sticky-off", !state.settings.stickyOn);
  $("stickyToggleBtn").textContent = "Sticky: " + (state.settings.stickyOn ? "ON" : "OFF");
}
function updateQuickViewClass(){
  document.body.classList.toggle("quick-view", !!state.settings.quickViewOn);
  $("quickViewBtn").textContent = "Chế độ: " + (state.settings.quickViewOn ? "Nhập nhanh" : "Đầy đủ");
}
function updateAdvancedBtn(){
  $("toggleAdvancedBtn").textContent = "Cột nâng cao: " + (state.settings.advancedColsOn ? "ON" : "OFF");
}

/* ================= Menus / Drawers ================= */
const backdrop = $("backdrop");
function openDrawer(panelId){
  $(panelId).classList.add("open");
  backdrop.classList.add("show");
}
function closeDrawer(panelId){
  $(panelId).classList.remove("open");
  backdrop.classList.remove("show");
}
function closeAll(){
  $("moreMenu").hidden = true;
  $("moreBtn").setAttribute("aria-expanded","false");
  closeDrawer("settingsPanel");
  closeDrawer("helpPanel");
}

/* ================= Events ================= */
function addRow(){
  const n = state.rows.length + 1;
  state.rows.push({ name:`SP ${n}`, sale:"", affFeePct:"", costInvoice:"", costReal:"" });
  rebuildTable();
}

function deleteRow(i){
  state.rows.splice(i,1);
  if(state.rows.length === 0) state.rows.push({ name:"SP 1", sale:"", affFeePct:"", costInvoice:"", costReal:"" });
  // re-number default names if user didn't edit? keep as-is; just rebuild
  rebuildTable();
}

function applySuggest(i){
  const row = state.rows[i];
  const costReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
  const costInv0 = parseMoney(row.costInvoice ?? row.cost);
  const costInv = isFinite(costInv0) ? costInv0 : costReal;
  const sug = isFinite(costReal) ? suggestSaleMinForTarget(costInv, costReal) : { ok:false };
  if(!sug.ok) return;
  row.sale = String(sug.sale);
  rebuildTable();
}

function bulkApply(){
  const rTarget = safePct(state.settings.targetPct)/100;
  let applied = 0;
  state.rows.forEach((row, i)=>{
    const c = calcRow(row);
    const ok = isFinite(c.roiOnSale) && c.roiOnSale >= rTarget;
    if(ok) return;
    const costReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
    const costInv0 = parseMoney(row.costInvoice ?? row.cost);
    const costInv = isFinite(costInv0) ? costInv0 : costReal;
    const sug = isFinite(costReal) ? suggestSaleMinForTarget(costInv, costReal) : { ok:false };
    if(sug.ok){ row.sale = String(sug.sale); applied++; }
  });
  rebuildTable();
  toast("Đã áp dụng đề xuất cho " + applied + " dòng.");
}

/* Input handling */
function onInput(e){
  const inp = e.target.closest("input[data-k]");
  if(!inp) return;
  const i = Number(inp.dataset.i);
  const k = inp.dataset.k;
  if(!isFinite(i) || !state.rows[i]) return;
  state.rows[i][k] = inp.value;
  // live update corresponding row
  updateRowDOM(i);
  updateMobileCardDOM(i);
}

function onBlur(e){
  const inp = e.target.closest("input[data-k]");
  if(!inp) return;
  const k = inp.dataset.k;
  if(k === "sale" || k === "costInvoice" || k === "costReal"){
    const v = inp.value;
    const n = parseMoney(v);
    if(isFinite(n)) inp.value = String(n); // normalize to plain number (will display with our fmt in outputs)
  }
  rebuildTable(); // also reapply filters/sort based on outputs
}

/* Mobile details toggle */
function onMobileToggleDetails(i){
  const card = mobileCards.querySelector(`.mcard[data-i="${i}"]`);
  if(!card) return;
  card.classList.toggle("open");
  const btn = card.querySelector('[data-action="toggleDetails"]');
  if(btn){
    const t = btn.querySelector(".toggleText");
    const ic = btn.querySelector(".toggleIcon");
    const open = card.classList.contains("open");
    t.textContent = open ? "Thu gọn" : "Xem thêm";
    ic.style.transform = open ? "rotate(180deg)" : "rotate(0deg)";
  }
}

/* ================= Excel: template / export / import ================= */
function ensureXLSX(){
  if(!window.XLSX){
    toast("Thiếu file xlsx.bundle.js (xlsx-js-style). Hãy đặt cùng thư mục với file HTML.");
    return false;
  }
  return true;
}

function buildExportRows(mode){
  const rTarget = safePct(state.settings.targetPct)/100;
  return state.rows.map((row, idx)=>{
    const c = calcRow(row);
    const costReal = parseMoney(row.costReal ?? row.costInvoice ?? row.cost);
    const costInv0 = parseMoney(row.costInvoice ?? row.cost);
    const costInv = isFinite(costInv0) ? costInv0 : costReal;
    const sug = isFinite(costReal) ? suggestSaleMinForTarget(costInv, costReal) : { ok:false };
    const sugSale = sug.ok ? sug.sale : "";

    const obj = {
      "Sản phẩm": row.name || ("SP " + (idx+1)),
      "Giá bán": parseMoney(row.sale),
      "Phí AFF (%)": (row.affFeePct!==undefined && String(row.affFeePct).trim()!=="") ? Number(row.affFeePct) : "",
      "Giá vốn (HĐ)": parseMoney(row.costInvoice ?? row.cost),
      "Giá vốn thực tế": parseMoney(row.costReal ?? row.costInvoice ?? row.cost),
      "Tiền về": c.moneyBack,
      "Thuế": c.taxAmt,
      "Tiền chênh": c.diffMoney,
      "LN thực tế": c.realProfit,
      "% chuẩn": isFinite(c.roiOnSale) ? (Math.round(c.roiOnSale*10000)/100) : "",
      "Phí cố định": c.fixed,
      "Lãi ròng": c.net,
      "Trạng thái": c.status,
      "Giá đề xuất": sugSale
    };

    const hit = isFinite(c.roiOnSale) && c.roiOnSale >= rTarget;
    const loss = isFinite(c.net) && c.net < 0;
    const warn = (isFinite(parseMoney(row.sale)) && isFinite(sugSale) && parseMoney(row.sale) > 0 && parseMoney(row.sale) < sugSale);

    if(mode === "not_hit" && hit) return null;
    if(mode === "loss" && !loss) return null;
    if(mode === "warn" && !warn) return null;
    return obj;
  }).filter(Boolean);
}

function exportExcel(){
  if(!ensureXLSX()) return;

  const mode = state.settings.exportMode || "all";
  const rows = buildExportRows(mode);

  // KPI row
  let sumMoneyBack=0, sumRealProfit=0, sumNet=0;
  rows.forEach(r=>{
    if(isFinite(r["Tiền về"])) sumMoneyBack += r["Tiền về"];
    if(isFinite(r["LN thực tế"])) sumRealProfit += r["LN thực tế"];
    if(isFinite(r["Lãi ròng"])) sumNet += r["Lãi ròng"];
  });

  const kpi = [{
    "Sản phẩm":"TỔNG",
    "Giá bán":"",
    "Phí AFF (%)":"",
    "Giá vốn (HĐ)":"",
    "Giá vốn thực tế":"",
    "Tiền về": sumMoneyBack,
    "Thuế":"",
    "Tiền chênh":"",
    "LN thực tế": sumRealProfit,
    "% chuẩn":"",
    "Phí cố định":"",
    "Lãi ròng": sumNet,
    "Trạng thái":"",
    "Giá đề xuất":""
  }];

  const ws = XLSX.utils.json_to_sheet([...kpi, ...rows], { skipHeader:false });
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DATA");

  // settings sheet
  const s = state.settings;
  const ws2 = XLSX.utils.aoa_to_sheet([
    ["SETTING","VALUE"],
    ["targetPct", s.targetPct],
    ["roundStep", s.roundStep],
    ["moneyBackFeePct", s.moneyBackFeePct],
    ["taxPct", s.taxPct],
    ["feeTaxPct", s.feeTaxPct],
    ["processOn", s.processOn],
    ["processFee", s.processFee],
    ["refundOn", s.refundOn],
    ["refundFee", s.refundFee],
  ]);
  XLSX.utils.book_append_sheet(wb, ws2, "SETTINGS");

  const out = XLSX.write(wb, { bookType:"xlsx", type:"array" });
  downloadBlob(new Blob([out], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}), "tiktok-profit-2026.xlsx");
}

function downloadTemplate(){
  if(!ensureXLSX()) return;
  const ws = XLSX.utils.aoa_to_sheet([
    ["Sản phẩm","Giá bán","Phí AFF (%)","Giá vốn (HĐ)","Giá vốn thực tế"],
    ["SP 1", 380000, 27, 225000, 225000],
    ["SP 2", "", "", "", ""]
  ]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "IMPORT");
  const out = XLSX.write(wb, { bookType:"xlsx", type:"array" });
  downloadBlob(new Blob([out], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}), "mau-import.xlsx");
}

function importExcelFile(file){
  if(!ensureXLSX()) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, {type:"array"});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
    // Try mapping by header
    const mapped = rows.map((r, idx)=>({
      name: r["Sản phẩm"] ?? r["name"] ?? r["Tên"] ?? ("SP " + (idx+1)),
      sale: r["Giá bán"] ?? r["sale"] ?? "",
      affFeePct: r["Phí AFF (%)"] ?? r["Phí AFF"] ?? r["affFeePct"] ?? "",
      costInvoice: r["Giá vốn (HĐ)"] ?? r["Giá vốn hóa đơn"] ?? r["costInvoice"] ?? r["cost"] ?? "",
      costReal: r["Giá vốn thực tế"] ?? r["costReal"] ?? r["Giá vốn thực"] ?? ""
    }));
    const cleaned = mapped.filter(x=>{
      const any = [x.name,x.sale,x.affFeePct,x.costInvoice,x.costReal].some(v=>String(v).trim()!=="");
      return any;
    });
    if(cleaned.length===0){
      toast("File không có dữ liệu hợp lệ.");
      return;
    }
    state.rows = cleaned.map((r,i)=>({
      name: String(r.name || ("SP " + (i+1))),
      sale: String(r.sale ?? ""),
      affFeePct: String(r.affFeePct ?? ""),
      costInvoice: String(r.costInvoice ?? ""),
      costReal: String(r.costReal ?? "")
    }));
    rebuildTable();
    toast("Import thành công: " + cleaned.length + " dòng.");
  };
  reader.readAsArrayBuffer(file);
}

/* ================= UI init ================= */
function initDDs(){
  buildDD("exportFilterDD", {
    value: ()=> state.settings.exportMode,
    set: (v)=> { state.settings.exportMode = v; },
    label: ()=> {
      const map = { all:"Xuất • Tất cả", not_hit:"Xuất • Chưa đạt", loss:"Xuất • Lỗ", warn:"Xuất • Cảnh báo" };
      return map[state.settings.exportMode] || "Xuất • Tất cả";
    },
    items: ()=> ([
      {value:"all", text:"Tất cả", sub:"Xuất toàn bộ"},
      {value:"not_hit", text:"Chưa đạt", sub:"Chỉ dòng chưa đạt"},
      {value:"loss", text:"Lỗ", sub:"Lãi ròng < 0"},
      {value:"warn", text:"Cảnh báo", sub:"Giá bán < đề xuất"}
    ])
  });

  buildDD("quickFilterDD", {
    value: ()=> state.settings.quickFilter,
    set: (v)=> { state.settings.quickFilter = v; },
    label: ()=> {
      const map = { all:"Bộ lọc: Tất cả", not_hit:"Bộ lọc: Chưa đạt", loss:"Bộ lọc: Lỗ", warn:"Bộ lọc: Cảnh báo" };
      return map[state.settings.quickFilter] || "Bộ lọc: Tất cả";
    },
    items: ()=> ([
      {value:"all", text:"Tất cả", sub:"Hiển thị tất cả dòng"},
      {value:"not_hit", text:"Chưa đạt", sub:"Chỉ dòng chưa đạt % mục tiêu"},
      {value:"loss", text:"Lỗ", sub:"Chỉ dòng lãi ròng âm"},
      {value:"warn", text:"Cảnh báo", sub:"Giá bán < đề xuất"}
    ])
  });

  buildDD("sortByDD", {
    value: ()=> state.settings.sortBy,
    set: (v)=> { state.settings.sortBy = v; },
    label: ()=> {
      const map = {
        none:"Sắp xếp: Mặc định",
        roi_desc:"% chuẩn: Cao → Thấp",
        roi_asc:"% chuẩn: Thấp → Cao",
        net_desc:"Lãi ròng: Cao → Thấp",
        net_asc:"Lãi ròng: Thấp → Cao",
        suggest_desc:"Đề xuất: Cao → Thấp",
        suggest_asc:"Đề xuất: Thấp → Cao"
      };
      return map[state.settings.sortBy] || "Sắp xếp: Mặc định";
    },
    items: ()=> ([
      {value:"none", text:"Mặc định", sub:"Theo thứ tự nhập"},
      {value:"roi_desc", text:"% chuẩn: Cao → Thấp"},
      {value:"roi_asc", text:"% chuẩn: Thấp → Cao"},
      {value:"net_desc", text:"Lãi ròng: Cao → Thấp"},
      {value:"net_asc", text:"Lãi ròng: Thấp → Cao"},
      {value:"suggest_desc", text:"Đề xuất: Cao → Thấp"},
      {value:"suggest_asc", text:"Đề xuất: Thấp → Cao"}
    ])
  });
}

function syncSettingsInputs(){
  $("targetPct").value = state.settings.targetPct;
  $("roundStep").value = state.settings.roundStep;
  $("moneyBackFeePct").value = state.settings.moneyBackFeePct;
  $("taxPct").value = state.settings.taxPct;
  $("feeTaxPct").value = state.settings.feeTaxPct;
  $("processFee").value = state.settings.processFee;
  $("refundFee").value = state.settings.refundFee;

  $("processToggle").classList.toggle("on", state.settings.processOn);
  $("processToggle").setAttribute("aria-checked", state.settings.processOn ? "true" : "false");
  $("refundToggle").classList.toggle("on", state.settings.refundOn);
  $("refundToggle").setAttribute("aria-checked", state.settings.refundOn ? "true" : "false");

  updateStickyClass();
  updateQuickViewClass();
  updateAdvancedBtn();
}

function attachSettingsEvents(){
  const map = [
    ["targetPct","targetPct"],["roundStep","roundStep"],["moneyBackFeePct","moneyBackFeePct"],
    ["taxPct","taxPct"],["feeTaxPct","feeTaxPct"],["processFee","processFee"],["refundFee","refundFee"]
  ];
  map.forEach(([id, key])=>{
    $(id).addEventListener("input", ()=>{
      state.settings[key] = Number($(id).value || 0);
      rebuildTable();
    });
  });

  function toggle(elId, key){
    const el = $(elId);
    const doToggle = ()=>{
      state.settings[key] = !state.settings[key];
      el.classList.toggle("on", state.settings[key]);
      el.setAttribute("aria-checked", state.settings[key] ? "true" : "false");
      rebuildTable();
    };
    el.addEventListener("click", doToggle);
    el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); doToggle(); }});
  }
  toggle("processToggle","processOn");
  toggle("refundToggle","refundOn");
}

/* ================= Wire up buttons ================= */
function init(){
  initDDs();
  syncSettingsInputs();
  attachSettingsEvents();

  rebuildTable();

  document.addEventListener("input", onInput);
  document.addEventListener("blur", onBlur, true);

  document.addEventListener("click", (e)=>{
    const act = e.target.closest("[data-action]");
    if(act){
      const action = act.dataset.action;
      if(action === "del"){ deleteRow(Number(act.dataset.del)); return; }
      if(action === "applySuggest"){ applySuggest(Number(act.dataset.i)); return; }
      if(action === "toggleDetails"){ onMobileToggleDetails(Number(act.dataset.i)); return; }
    }
  });

  $("addRowBtn").addEventListener("click", addRow);

  $("importBtn").addEventListener("click", ()=> $("excelInput").click());
  $("excelInput").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importExcelFile(f);
    e.target.value = "";
  });

  $("exportBtn").addEventListener("click", exportExcel);

  $("downloadTemplateBtn").addEventListener("click", ()=>{ downloadTemplate(); closeAll(); });
  $("bulkApplyBtn").addEventListener("click", ()=>{ bulkApply(); closeAll(); });

  $("settingsBtn").addEventListener("click", ()=>{ openDrawer("settingsPanel"); $("moreMenu").hidden = true; });
  $("helpBtn").addEventListener("click", ()=>{ openDrawer("helpPanel"); $("moreMenu").hidden = true; });
  $("settingsCloseBtn").addEventListener("click", ()=> closeDrawer("settingsPanel"));
  $("helpCloseBtn").addEventListener("click", ()=> closeDrawer("helpPanel"));
  backdrop.addEventListener("click", closeAll);

  $("resetBtn").addEventListener("click", ()=>{
    state = JSON.parse(JSON.stringify(DEFAULT_STATE));
    syncSettingsInputs();
    rebuildTable();
    closeAll();
  });

  $("quickViewBtn").addEventListener("click", ()=>{
    state.settings.quickViewOn = !state.settings.quickViewOn;
    updateQuickViewClass();
    rebuildTable();
  });

  $("toggleAdvancedBtn").addEventListener("click", ()=>{
    state.settings.advancedColsOn = !state.settings.advancedColsOn;
    updateAdvancedBtn();
    applyAdvancedCols();
    rebuildTable();
  });

  $("stickyToggleBtn").addEventListener("click", ()=>{
    state.settings.stickyOn = !state.settings.stickyOn;
    updateStickyClass();
    rebuildTable();
  });

  const moreBtn = $("moreBtn");
  const moreMenu = $("moreMenu");
  moreBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    const open = moreMenu.hidden;
    if(open){
      // position under button
      const r = moreBtn.getBoundingClientRect();
      moreMenu.style.left = Math.max(12, Math.min(window.innerWidth - moreMenu.offsetWidth - 12, r.left)) + "px";
      moreMenu.style.top = (r.bottom + 8) + "px";
    }
    moreMenu.hidden = !open;
    moreBtn.setAttribute("aria-expanded", open ? "true" : "false");
  });
  document.addEventListener("click", (e)=>{
    if(!moreMenu.contains(e.target) && e.target !== moreBtn){
      moreMenu.hidden = true;
      moreBtn.setAttribute("aria-expanded","false");
    }
  });

  // Mobile bar
  $("mbAdd").addEventListener("click", addRow);
  $("mbImport").addEventListener("click", ()=> $("excelInput").click());
  $("mbApply").addEventListener("click", bulkApply);
  $("mbMore").addEventListener("click", ()=> moreBtn.click());

  // keep mobile bar height reserve
  const bar = $("mobileBar");
  const ro = new ResizeObserver(()=> {
    const h = bar.getBoundingClientRect().height;
    document.documentElement.style.setProperty("--mobileBarSpace", (h + 18) + "px");
  });
  ro.observe(bar);
}

init();
</script>
</body>
</html>
